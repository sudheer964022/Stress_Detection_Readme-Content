@startmermaid
graph TD
    %% ==========================================
    %% ðŸŽ¨ STYLING DEFINITIONS
    %% ==========================================
    classDef startend fill:#212121,stroke:#000,stroke-width:2px,color:#fff;
    classDef process fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000;
    classDef decision fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#000;
    classDef io fill:#e0f2f1,stroke:#00695c,stroke-width:2px,color:#000;
    classDef database fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000;
    classDef alert fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000;

    %% ==========================================
    %% ðŸš€ AUTHENTICATION FLOW
    %% ==========================================
    Start([ðŸš€ Start Application]):::startend --> Spash[Show Splash Screen]:::io
    Spash --> CheckDB{Checking MongoDB...}:::decision
    
    CheckDB -- Error --> DBError[Show Connection Error Dialog]:::alert
    DBError --> RetryDB{Retry?}:::decision
    RetryDB -- Yes --> CheckDB
    RetryDB -- No --> Exit([Exit App]):::startend

    CheckDB -- Connected --> LoginUI[ðŸ–¥ï¸ Display Login Window]:::io
    
    LoginUI --> UserAction{User Interaction}:::decision

    %% --- REGISTRATION SUB-FLOW ---
    UserAction -- Click 'Register' --> RegForm[ðŸ“ Show Registration Dialog]:::io
    RegForm --> InputReg[Input: Name, Email, Phone, Pass]:::io
    InputReg --> ValidateReg{Validate Inputs}:::decision
    
    ValidateReg -- Invalid --> ShowRegError[âš ï¸ Show Validation Error]:::alert
    ShowRegError --> InputReg
    
    ValidateReg -- Valid --> CheckDupe{Check User Exists?}:::database
    CheckDupe -- Yes --> ShowExistsError[âš ï¸ Email/Phone Already Used]:::alert
    ShowExistsError --> InputReg
    
    CheckDupe -- No --> CreateAccount[ðŸ’¾ Create 'Inactive' Account in DB]:::database
    CreateAccount --> RegSuccess[âœ… Show Success Message]:::io
    RegSuccess --> LoginUI

    %% --- LOGIN SUB-FLOW ---
    UserAction -- Enter Credentials --> AuthProc[Authenticating...]:::process
    AuthProc --> FetchUser{Query User DB}:::database
    
    FetchUser -- Not Found --> LoginFail[âŒ Show 'User Not Found']:::alert
    LoginFail --> LoginUI
    
    FetchUser -- Found --> VerifyPass{Check User Status}:::decision
    
    VerifyPass -- Inactive --> AccountLocked[ðŸ”’ Show 'Account Pending Approval']:::alert
    AccountLocked --> LoginUI

    VerifyPass -- Active --> CheckPass{Verify Password (Bcrypt)}:::process
    CheckPass -- Invalid --> PassFail[âŒ Show 'Invalid Password']:::alert
    PassFail --> LoginUI

    CheckPass -- Valid --> GenToken[ðŸ”‘ Generate Session Token]:::process
    GenToken --> DetermineRole{Determine User Role}:::decision

    %% ==========================================
    %% ðŸ‘¨â€ðŸ’» EMPLOYEE WORKFLOW
    %% ==========================================
    DetermineRole -- Employee --> EmpDash[ðŸ‘¤ Open Employee Dashboard]:::io
    
    subgraph "Real-Time Monitoring Loop"
        EmpDash --> InitCam[ðŸ“· Initialize Webcam]:::process
        InitCam --> ReadFrame[Read Video Frame]:::process
        ReadFrame --> FaceDet[ðŸ¤– MediaPipe: Face Detection]:::process
        
        FaceDet -- No Face --> ShowNoFace[âš ï¸ 'No Face Detected' Warning]:::alert
        ShowNoFace --> ReadFrame
        
        FaceDet -- Face Found --> ExtractLMs[ðŸ“ Extract 468 Landmarks]:::process
        ExtractLMs --> CalcPhysio[ðŸ§® Calculate: Blink, Mouth, Eye Closure]:::process
        
        CalcPhysio --> DeepFace[ðŸ§  DeepFace CNN: Emotion Recognition]:::process
        DeepFace --> CalcStress[ðŸ“Š Calculate Stress Score (0.0 - 1.0)]:::process
        
        CalcStress --> SaveRecord[ðŸ’¾ Save Stress Record to DB]:::database
        SaveRecord --> UpdateUI[ðŸ“ˆ Update Live Graph & Stats]:::io
        
        UpdateUI --> StressCheck{Stress Level > Threshold?}:::decision
        StressCheck -- High/Medium --> TrigAlert[ðŸš¨ Trigger Pop-up Alert]:::alert
        TrigAlert --> ShowRec[ðŸ’¡ Show Health Recommendation]:::io
        ShowRec --> ReadFrame
        
        StressCheck -- Low --> ReadFrame
    end
    
    EmpDash -- Click 'History' --> ViewHistory[ðŸ“… View Weekly/Monthly Stress]:::io
    EmpDash -- Click 'Profile' --> EditProfile[âœï¸ Edit Account Details]:::io

    %% ==========================================
    %% ðŸ‘” MANAGER WORKFLOW
    %% ==========================================
    DetermineRole -- Manager --> MgrDash[ðŸ‘” Open Manager Dashboard]:::io
    
    MgrDash --> FetchTeam[ðŸ‘¥ Fetch Assigned Employees]:::database
    FetchTeam --> RenderTeam[Show Team Grid Output]:::io
    
    subgraph "Manager Monitoring"
        RenderTeam --> AutoRefresh[ðŸ”„ Poll DB every 5s]:::process
        AutoRefresh --> CheckStatus{Analyze Latest Records}:::decision
        
        CheckStatus -- High Stress --> HighlightRed[ðŸ”´ Highlight Employee Red]:::alert
        CheckStatus -- Medium Stress --> HighlightYellow[ðŸŸ¡ Highlight Employee Yellow]:::alert
        CheckStatus -- Low Stress --> HighlightGreen[ðŸŸ¢ Highlight Employee Green]:::process
        
        HighlightRed --> NotifyMgr[ðŸ”” Send Desktop Notification]:::alert
    end
    
    MgrDash -- Select Employee --> DrillDown[ðŸ” View Employee Detail History]:::io

    %% ==========================================
    %% ðŸ›¡ï¸ ADMIN WORKFLOW
    %% ==========================================
    DetermineRole -- Admin --> AdminPanel[ðŸ›¡ï¸ Open Admin Panel]:::io
    
    AdminPanel --> FetchAllUsers[ðŸ“‚ Fetch All Users]:::database
    FetchAllUsers --> UserTable[Show User Management Table]:::io
    
    subgraph "User Management"
        UserTable --> AdminAction{Select Action}:::decision
        
        AdminAction -- Add User --> AddUserForm[âž• Add New User]:::io
        AddUserForm --> SaveNewUser[ðŸ’¾ Insert into DB]:::database
        
        AdminAction -- Edit User --> EditDialog[âœï¸ Edit User Details]:::io
        EditDialog --> UpdateUser[ðŸ’¾ Update DB Record]:::database
        
        AdminAction -- Delete --> ConfirmDel[ðŸ—‘ï¸ Confirm Deletion]:::alert
        ConfirmDel --> RemoveUser[âŒ Delete from DB]:::database
        
        AdminAction -- Approve --> ActivateAcc[âœ… Set Active = True]:::database
        
        AdminAction -- Assign Mgr --> MapRel[ðŸ”— Link Employee to Manager]:::database
    end
    
    AdminPanel --> ViewAnalytics[ðŸ“Š View System-Wide Analytics]:::io

@endmermaid
