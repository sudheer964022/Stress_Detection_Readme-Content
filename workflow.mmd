@startmermaid
graph TD
    classDef startend fill:#212121,stroke:#000,stroke-width:2px,color:#fff;
    classDef process fill:#e3f2fd,stroke:#1565c0,stroke-width:2px,color:#000;
    classDef decision fill:#fff9c4,stroke:#fbc02d,stroke-width:2px,color:#000;
    classDef io fill:#e0f2f1,stroke:#00695c,stroke-width:2px,color:#000;
    classDef alert fill:#ffebee,stroke:#c62828,stroke-width:2px,color:#000;
    classDef database fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000;

    Start([Start Application]):::startend --> Splash[Show Splash Screen]:::io
    Splash --> CheckDB{Checking MongoDB}:::decision
    
    CheckDB -- Error --> DBError[Show Connection Error]:::alert
    DBError --> RetryDB{Retry?}:::decision
    RetryDB -- Yes --> CheckDB
    RetryDB -- No --> Exit([Exit App]):::startend

    CheckDB -- Connected --> LoginUI[Display Login Window]:::io
    LoginUI --> UserAction{User Interaction}:::decision

    %% Registration
    UserAction -- Register --> RegForm[Show Registration Dialog]:::io
    RegForm --> InputReg[Input Details]:::io
    InputReg --> ValidateReg{Validate Inputs}:::decision
    
    ValidateReg -- Invalid --> ShowRegError[Show Validation Error]:::alert
    ShowRegError --> InputReg
    
    ValidateReg -- Valid --> CheckDupe{User Exists?}:::database
    CheckDupe -- Yes --> ShowExistsError[Email or Phone Used]:::alert
    ShowExistsError --> InputReg
    
    CheckDupe -- No --> CreateAccount[Create Inactive Account]:::database
    CreateAccount --> RegSuccess[Show Success Message]:::io
    RegSuccess --> LoginUI

    %% Login
    UserAction -- Login --> AuthProc[Authenticating]:::process
    AuthProc --> FetchUser{Query User DB}:::database
    
    FetchUser -- Not Found --> LoginFail[Show User Not Found]:::alert
    LoginFail --> LoginUI
    
    FetchUser -- Found --> VerifyPass{Check User Status}:::decision
    
    VerifyPass -- Inactive --> AccountLocked[Show Account Pending]:::alert
    AccountLocked --> LoginUI

    VerifyPass -- Active --> CheckPass{Verify Password}:::process
    CheckPass -- Invalid --> PassFail[Show Invalid Password]:::alert
    PassFail --> LoginUI

    CheckPass -- Valid --> GenToken[Generate Session Token]:::process
    GenToken --> DetermineRole{User Role?}:::decision

    %% Employee
    DetermineRole -- Employee --> EmpDash[Open Employee Dashboard]:::io
    
    subgraph Monitoring ["Real-Time Monitoring Loop"]
        EmpDash --> InitCam[Initialize Webcam]:::process
        InitCam --> ReadFrame[Read Video Frame]:::process
        ReadFrame --> FaceDet[MediaPipe Face Detection]:::process
        
        FaceDet -- No Face --> ShowNoFace[Warning: No Face]:::alert
        ShowNoFace --> ReadFrame
        
        FaceDet -- Found --> ExtractLMs[Extract Landmarks]:::process
        ExtractLMs --> CalcPhysio[Calculate Physiological Metrics]:::process
        
        CalcPhysio --> DeepFace[DeepFace Emotion Recognition]:::process
        DeepFace --> CalcStress[Calculate Stress Score]:::process
        
        CalcStress --> SaveRecord[Save to DB]:::database
        SaveRecord --> UpdateUI[Update Graph and Stats]:::io
        
        UpdateUI --> StressCheck{Check Stress Level}:::decision
        StressCheck -- High or Medium --> TrigAlert[Trigger Alert]:::alert
        TrigAlert --> ShowRec[Show Recommendation]:::io
        ShowRec --> ReadFrame
        
        StressCheck -- Low --> ReadFrame
    end

    %% Manager
    DetermineRole -- Manager --> MgrDash[Open Manager Dashboard]:::io
    
    MgrDash --> FetchTeam[Fetch Assigned Employees]:::database
    FetchTeam --> RenderTeam[Show Team Grid]:::io
    
    subgraph ManagerMonitor ["Manager Monitoring"]
        RenderTeam --> AutoRefresh[Poll DB every 5s]:::process
        AutoRefresh --> CheckStatus{Analyze Status}:::decision
        
        CheckStatus -- High Stress --> HighlightRed[Red Highlight]:::alert
        CheckStatus -- Medium --> HighlightYellow[Yellow Highlight]:::alert
        CheckStatus -- Low --> HighlightGreen[Green Highlight]:::process
        
        HighlightRed --> NotifyMgr[Desktop Notification]:::alert
    end

    %% Admin
    DetermineRole -- Admin --> AdminPanel[Open Admin Panel]:::io
    
    AdminPanel --> FetchUsers[Fetch All Users]:::database
    FetchUsers --> UserTable[Show User Table]:::io
    
    subgraph UserMgmt ["User Management"]
        UserTable --> AdminAction{Select Action}:::decision
        
        AdminAction -- Add --> AddUserForm[Add User]:::io
        AddUserForm --> SaveNewUser[Insert into DB]:::database
        
        AdminAction -- Edit --> EditDialog[Edit User]:::io
        EditDialog --> UpdateUser[Update DB]:::database
        
        AdminAction -- Delete --> ConfirmDel[Confirm Delete]:::alert
        ConfirmDel --> RemoveUser[Delete from DB]:::database
    end
@endmermaid
